/* =============================================================================
# TestTMS

- Version: 1.6 (27/06/2025)
- Author: mvac7/303bcn
- Architecture: MSX
- Format: .COM (MSX-DOS)
- Programming language: C and Z80 assembler
- Compiler: SDCC 4.4 or newer 

## Description:
Test VDP TMS9918A MSX Library (fR3eL Project)

## Histoy of versions: (dd/mm/yyyy)
- v1.6 (27/06/2025)<Add TestCLS
- v1.5 (14/12/2023)<Update to SDCC (4.1.12) Z80 calling conventions
					Test FastVPOKE function
- v1.4 (23/07/2019)
- v1.3 ( 4/05/2019)
============================================================================= */

// ---------------------------------------------------------------------------- Includes
#include "../include/newTypes.h"
#include "../include/msxBIOS.h"
#include "../include/msxSystemVariables.h"
#include "../include/msxDOS.h"

#include "../include/keyboard_MSX.h"
#include "../include/VDP_TMS9918A.h"



#define  HALT __asm halt __endasm   //wait for the next interrupt



// ---------------------------------------------------------------------------- Labels




// ---------------------------------------------------------------------------- Function Declaration
void WAIT(uint cicles);

void SCREEN0(void);
void SCREEN1(void);

char ReadBIOS(uint addr);
char PEEK(uint address);
void POKE(uint address, char value);

boolean isTxtMode(void);

char GetVFrequency(void);

void VLOCATE(char column, char line);
void VPRINT(char* text);

void PRINT(char* text);

void DrawHorzLine(char tile, char size);
void DrawBox(char width, char height);
void DrawFillBox(char width, char height, char tile);

void ClearVRAM(void);

void ShowMenu(void);
void Menu(void);

//void testCOLOR(void);

void testSCREEN0(void);
void testSCREEN1(void);
void testSCREEN2(void);
void testSCREEN3(void);

void testCLS(void);

void testFill(void);
void testVpeekVpoke(void);

void testSprites(void);
void showSprites(char offset);



// ---------------------------------------------------------------------------- Constants
const char text01[] = "Test VDP_TMS9918A Lib"; 

const char textMENU[6][30] = {
"[F1] Test TEXT1     (Screen0)",
"[F2] Test GRAPHIC1  (Screen1)",
"[F3] Test GRAPHIC2  (Screen2)",
"[F4] Test MULTICOLOR(Screen3)",
"[F5] Test Sprites            ",
"[ESC] Exit                   "};

const char text10[] = "Test CLS()";

const char textVers[4][7] = {"MSX1","MSX2","MSX2+","turboR"};
const char textVFreq[2][5] = {"NTSC","PAL"};

const char msg_PressKey[] = "Press any key to continue";



// ---------------------------------------------------------
// tMSgfX devtool v0.9.16.0
// Tileset Pattern Data - Mode:G1
// Tiles range: 0 to 127
// Size=1024
const char font01Bold_sc06x8_PAT[]={
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xAA,0x55,0xAA,0x55,0xAA,0x55,0xAA,0x55,
0x00,0x01,0x03,0x07,0x0F,0x1F,0x3F,0x7F,
0x80,0xC0,0xE0,0xF0,0xF8,0xFC,0xFE,0xFF,
0x7F,0x3F,0x1F,0x0F,0x07,0x03,0x01,0x00,
0xFF,0xFE,0xFC,0xF8,0xF0,0xE0,0xC0,0x80,
0x01,0x02,0x04,0x08,0x10,0x20,0x40,0x80,
0x80,0x40,0x20,0x10,0x08,0x04,0x02,0x01,
0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x18,0x18,0x18,0xFF,0xFF,0x00,0x00,0x00,
0x00,0x00,0x00,0xFF,0xFF,0x18,0x18,0x18,
0x18,0x18,0x18,0xF8,0xF8,0x18,0x18,0x18,
0x18,0x18,0x18,0x1F,0x1F,0x18,0x18,0x18,
0x18,0x18,0x18,0xFF,0xFF,0x18,0x18,0x18,
0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
0x00,0x00,0x00,0x0F,0x1F,0x18,0x18,0x18,
0x00,0x00,0x00,0xF0,0xF8,0x18,0x18,0x18,
0x18,0x18,0x18,0x1F,0x0F,0x00,0x00,0x00,
0x18,0x18,0x18,0xF8,0xF0,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x30,0x30,0x30,0x30,0x00,0x30,0x00,
0x00,0x50,0x50,0x00,0x00,0x00,0x00,0x00,
0x00,0x50,0xF8,0x50,0xF8,0x50,0x00,0x00,
0x20,0xF8,0xA0,0xF8,0x28,0xF8,0x20,0x00,
0x00,0xCC,0xD8,0x30,0x6C,0xCC,0x00,0x00,
0x00,0x60,0xB0,0xF4,0xD8,0xF4,0x00,0x00,
0x00,0x30,0x60,0x00,0x00,0x00,0x00,0x00,
0x18,0x30,0x30,0x30,0x30,0x30,0x18,0x00,
0x30,0x18,0x18,0x18,0x18,0x18,0x30,0x00,
0x00,0xB4,0x78,0xFC,0x78,0xB4,0x00,0x00,
0x00,0x30,0x30,0xFC,0x30,0x30,0x00,0x00,
0x00,0x00,0x00,0x00,0x30,0x30,0x20,0x00,
0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,
0x00,0x0C,0x18,0x30,0x60,0xC0,0x00,0x00,
0x70,0xD8,0xD8,0xD8,0xD8,0x70,0x00,0x00,
0x30,0x70,0x30,0x30,0x30,0x78,0x00,0x00,
0xF0,0x18,0x70,0xC0,0xC0,0xF8,0x00,0x00,
0xF0,0x18,0x70,0x18,0x18,0xF0,0x00,0x00,
0xD8,0xD8,0xF8,0x18,0x18,0x18,0x00,0x00,
0xF8,0xC0,0xF0,0x18,0x18,0xF0,0x00,0x00,
0x70,0xC0,0xF0,0xD8,0xD8,0x70,0x00,0x00,
0xF8,0x18,0x30,0x60,0x60,0x60,0x00,0x00,
0x70,0xD8,0x70,0xD8,0xD8,0x70,0x00,0x00,
0x70,0xD8,0xD8,0x78,0x18,0x70,0x00,0x00,
0x00,0x30,0x30,0x00,0x30,0x30,0x00,0x00,
0x00,0x30,0x30,0x00,0x30,0x30,0x20,0x00,
0x00,0x18,0x30,0x60,0x30,0x18,0x00,0x00,
0x00,0x00,0x78,0x00,0x78,0x00,0x00,0x00,
0x00,0x60,0x30,0x18,0x30,0x60,0x00,0x00,
0x78,0xCC,0x0C,0x18,0x30,0x00,0x30,0x00,
0x78,0x84,0xB4,0xD4,0xBC,0x80,0x78,0x00,
0x70,0xD8,0xD8,0xF8,0xD8,0xD8,0x00,0x00,
0xF0,0xD8,0xF0,0xD8,0xD8,0xF0,0x00,0x00,
0x78,0xC0,0xC0,0xC0,0xC0,0x78,0x00,0x00,
0xF0,0xD8,0xD8,0xD8,0xD8,0xF0,0x00,0x00,
0xF8,0xC0,0xF0,0xC0,0xC0,0xF8,0x00,0x00,
0xF8,0xC0,0xF0,0xC0,0xC0,0xC0,0x00,0x00,
0x70,0xC0,0xC0,0xD8,0xD8,0x78,0x00,0x00,
0xD8,0xD8,0xF8,0xD8,0xD8,0xD8,0x00,0x00,
0x60,0x60,0x60,0x60,0x60,0x60,0x00,0x00,
0x30,0x30,0x30,0x30,0x30,0xE0,0x00,0x00,
0xD8,0xD8,0xF0,0xD8,0xD8,0xD8,0x00,0x00,
0xC0,0xC0,0xC0,0xC0,0xC0,0xF8,0x00,0x00,
0x88,0xD8,0xF8,0xF8,0xD8,0xD8,0x00,0x00,
0x98,0xD8,0xF8,0xF8,0xD8,0xC8,0x00,0x00,
0x70,0xD8,0xD8,0xD8,0xD8,0x70,0x00,0x00,
0xF0,0xD8,0xD8,0xD8,0xF0,0xC0,0x00,0x00,
0x70,0xD8,0xD8,0xD8,0xD0,0x68,0x00,0x00,
0xF0,0xD8,0xD8,0xF0,0xD8,0xD8,0x00,0x00,
0x78,0xC0,0xF0,0x78,0x18,0xF0,0x00,0x00,
0x78,0x30,0x30,0x30,0x30,0x30,0x00,0x00,
0xD8,0xD8,0xD8,0xD8,0xD8,0x70,0x00,0x00,
0xD8,0xD8,0xD8,0xD8,0x70,0x20,0x00,0x00,
0xD8,0xD8,0xD8,0xF8,0xD8,0x88,0x00,0x00,
0xD8,0xD8,0x70,0x70,0xD8,0xD8,0x00,0x00,
0xCC,0xCC,0xCC,0x78,0x30,0x30,0x00,0x00,
0xF8,0x18,0x30,0x60,0xC0,0xF8,0x00,0x00,
0x38,0x30,0x30,0x30,0x30,0x30,0x38,0x00,
0x00,0xC0,0x60,0x30,0x18,0x0C,0x00,0x00,
0x70,0x30,0x30,0x30,0x30,0x30,0x70,0x00,
0x20,0x70,0xD8,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x70,0x18,0x78,0xD8,0xF8,0x00,0x00,
0xC0,0xF0,0xC8,0xC8,0xC8,0xF0,0x00,0x00,
0x00,0x78,0xC0,0xC0,0xC0,0x78,0x00,0x00,
0x18,0x78,0xD8,0xD8,0xD8,0x78,0x00,0x00,
0x00,0x70,0xD8,0xF8,0xC0,0x70,0x00,0x00,
0x38,0x60,0x60,0xF8,0x60,0x60,0x00,0x00,
0x00,0x70,0xD8,0xD8,0x78,0x18,0xF0,0x00,
0xC0,0xF0,0xD8,0xD8,0xD8,0xD8,0x00,0x00,
0x30,0x00,0x30,0x30,0x30,0x30,0x00,0x00,
0x30,0x00,0x30,0x30,0x30,0x30,0xE0,0x00,
0xC0,0xD8,0xD8,0xF0,0xD8,0xD8,0x00,0x00,
0x30,0x30,0x30,0x30,0x30,0x30,0x00,0x00,
0x00,0xF0,0xA8,0xA8,0xA8,0xA8,0x00,0x00,
0x00,0xF0,0xD8,0xD8,0xD8,0xD8,0x00,0x00,
0x00,0x70,0xD8,0xD8,0xD8,0x70,0x00,0x00,
0x00,0xF0,0xD8,0xD8,0xD8,0xF0,0xC0,0x00,
0x00,0x78,0xD8,0xD8,0xD8,0x78,0x18,0x00,
0x00,0x78,0xC0,0xC0,0xC0,0xC0,0x00,0x00,
0x00,0x78,0xC0,0x70,0x18,0xF0,0x00,0x00,
0x60,0xF8,0x60,0x60,0x60,0x38,0x00,0x00,
0x00,0xD8,0xD8,0xD8,0xD8,0x70,0x00,0x00,
0x00,0xD8,0xD8,0xD8,0x70,0x20,0x00,0x00,
0x00,0xD8,0xD8,0xA8,0xF8,0xA8,0x00,0x00,
0x00,0xD8,0x70,0x20,0x70,0xD8,0x00,0x00,
0x00,0xD8,0xD8,0xD8,0x78,0x18,0xF0,0x00,
0x00,0xF8,0x18,0x30,0x60,0xF8,0x00,0x00,
0x18,0x30,0x30,0x60,0x30,0x30,0x18,0x00,
0x30,0x30,0x30,0x00,0x30,0x30,0x30,0x00,
0x60,0x30,0x30,0x18,0x30,0x30,0x60,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};


// Tileset Color Data - Mode:G1
// Size=32
const char font01Bold_sc06x8_COL[]={
0x74,0x74,0x74,0x74,0xF4,0xF4,0xF4,0xF4,
0xF4,0xF4,0xF4,0xF4,0xF4,0xF4,0xF4,0xF4,
0x00,0x11,0x22,0x33,0x44,0x55,0x66,0x77,
0x88,0x99,0xAA,0xBB,0xCC,0xDD,0xEE,0xFF};


// Tileset Color Data - Mode:G1
// Size=32
const char tileset_06x8_COL2[]={
0x94,0x94,0x34,0x34,0xB4,0xB4,0x74,0x74,
0xF4,0xF4,0xF4,0xF4,0xE4,0xE4,0xE4,0xE4,
0xF4,0xF4,0xF4,0xF4,0xF4,0xF4,0xF4,0xF4,
0xF4,0xF4,0xF4,0xF4,0xF4,0xF4,0xF4,0xF4};


const char sprcol[8]={12,2,3,7,6,8,9,14};


// ---------------------------------------------------------
// tMSgfX devtool v0.9.16.0
// Project: TestTMS_sprites.PNG
// ---------------------------------------------------------
// SpriteSet Pattern Data - Size=16x16 - Mode=Mode1 Monocolor
// Sprite range: 0 to 9
// Size=320
const char SPRITE_DATA[]={
0x3C,0x42,0xA5,0x81,0xA5,0x99,0x42,0x3C,
0x3C,0x7E,0xDB,0xFF,0xFF,0xDB,0x66,0x3C,
0x6C,0xFE,0xFE,0xFE,0x7C,0x38,0x10,0x00,
0x10,0x38,0x7C,0xFE,0x7C,0x38,0x10,0x00,
0x10,0x38,0x54,0xFE,0x54,0x10,0x38,0x00,
0x10,0x38,0x7C,0xFE,0xFE,0x10,0x38,0x00,
0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,
0xFF,0xFF,0xFF,0xE7,0xE7,0xFF,0xFF,0xFF,
0x0F,0x1F,0x3D,0x3F,0x7B,0x7C,0xBF,0xBF,
0x9F,0xEF,0x6F,0x1F,0x0F,0x05,0x05,0x1D,
0xC0,0xE0,0x60,0xC0,0x40,0x80,0x80,0x84,
0x86,0xDE,0xC0,0xC0,0x80,0x00,0x00,0xC0,
0x05,0x07,0x1A,0x2E,0x6F,0x5B,0x5C,0x5B,
0x5F,0x58,0x6F,0x2D,0x16,0x02,0x02,0x06,
0x40,0xC0,0xB8,0xD4,0xD4,0x6A,0xEA,0x6A,
0xEA,0x6A,0xD4,0xD4,0xF8,0x40,0x40,0x60,
0x03,0x07,0x4F,0xCF,0x4D,0x4F,0x2C,0x1E,
0x3F,0x3F,0x3F,0x3F,0x1F,0x02,0x02,0x06,
0xC0,0xE2,0xE6,0xE2,0xA2,0xF4,0x38,0x7C,
0xFE,0xFE,0xFE,0xFC,0xF8,0x40,0x40,0x60,
0x05,0x1E,0x3F,0x6F,0x57,0x6E,0x3F,0x00,
0x07,0x05,0x07,0x04,0x06,0x03,0x02,0x06,
0x60,0xF8,0xF4,0xEA,0x76,0xBE,0x7C,0x00,
0xE0,0x60,0xE0,0x20,0x60,0xC0,0x40,0x60,
0x05,0x07,0x1F,0x3F,0x7F,0x7F,0x7F,0x7D,
0x7F,0x7F,0x78,0x3F,0x1F,0x04,0x04,0x0C,
0x40,0xC0,0xF0,0xF8,0xFC,0xFC,0xFC,0x7C,
0xFC,0xFC,0x3C,0xF8,0xF0,0x40,0x40,0x60,
0x07,0x1F,0x3F,0x3F,0x7F,0x71,0x7F,0x7F,
0x7F,0x7E,0x3E,0x3F,0x1F,0x07,0x02,0x06,
0xE0,0xF8,0xFC,0xFC,0xFE,0x8E,0xFE,0xFE,
0xFE,0x7E,0x7C,0xFC,0xF8,0xE0,0x40,0x60,
0x00,0x07,0x1F,0x3F,0x7F,0x71,0xFF,0xFF,
0x7B,0x7C,0x3F,0x1F,0x07,0x02,0x02,0x06,
0x00,0xE0,0xF8,0xFC,0xFE,0x8E,0xFF,0xFF,
0xDE,0x3E,0xFC,0xF8,0xE0,0x40,0x40,0x60,
0x05,0x1E,0x3F,0x6F,0x57,0x6E,0x3F,0x00,
0x07,0x05,0x07,0x04,0x06,0x03,0x02,0x06,
0x60,0xF8,0xF4,0xEA,0x76,0xBE,0x7C,0x00,
0xE0,0x60,0xE0,0x20,0x60,0xC0,0x40,0x60};



// ---------------------------------------------------------------------------- Global Variables
uint vprint_addr;
uint time;

char tilesetBakup[1024];


// ---------------------------------------------------------------------------- Functions


//
void main(void)
{
  char colorInk=0;
  char colorBG=0;
  char colorBDR=0;
  char scrcolumns=0;
  
  colorInk=PEEK(FORCLR);
  colorBG=PEEK(BAKCLR);
  colorBDR=PEEK(BDRCLR);
  scrcolumns=PEEK(LINLEN);


  //HALT;
  PRINT(text01); 
  PRINT("\n\r");
  PRINT(msg_PressKey);
  INKEY();

  
//TEST -------------------------------------------------------------------------   
  Menu();
  

//EXIT MSXDOS ------------------------------------------------------------------
  //restore MSX-DOS screen
  COLOR(colorInk,colorBG,colorBDR);
//  WIDTH(scrcolumns);

  if(scrcolumns<33) SCREEN1();
  else SCREEN0();
  //
  
  PRINT("END Test");
  
  KillBuffer(); //Clear keyboard system buffer
    
//--------------------------------------------------------------------- end EXIT   
}



void SCREEN0(void)
{
__asm

	push IX

	ld   A,(#LINLEN)
	ld   (#LINL40),A	;copy columns seting with WIDTH to LINL40 system var

	ld   IX,#BIOS_INITXT
	ld   IY,(EXPTBL-1)
	call BIOS_CALSLT
	ei

	pop  IX
  
__endasm;
}



void SCREEN1(void)
{
__asm
     
	push IX

	ld   A,(#LINLEN)	;get a last value set with WIDTH function 
	ld   (#LINL32),A	;set system variable

	ld   IX,#BIOS_INIT32
	ld   IY,(EXPTBL-1)
	call BIOS_CALSLT
	ei

	pop  IX
  
__endasm;
}




// Generates a pause in the execution of n interruptions.
// PAL: 50=1second. ; NTSC: 60=1second. 
void WAIT(uint cicles)
{
	uint i;
	for(i=0;i<cicles;i++) HALT;
}



char ReadBIOS(uint addr) __naked
{
addr;
__asm
	push IX

	LD    A,(EXPTBL)	;EXPTBL=main BIOS-ROM slot address
	CALL  BIOS_RDSLT	;Reads the value of an address in another slot
	EI    

	pop  IX
	ret
__endasm; 
}



char PEEK(uint address) __naked
{
address;
__asm
	ld   A,(HL)
	ret
__endasm;
}



void POKE(uint address, char value)
{
address;value;
__asm
	push IX
	ld   IX,#0
	add  IX,SP

	ld   A,4(IX)
	ld   (HL),A

	pop  IX  
__endasm;
}



void DrawHorzLine(char tile, char size)
{
	char i;
	for(i=0;i<size;i++) FastVPOKE(tile);
}



void DrawBox(char width, char height)
{
	char box_winside = width-2;
	char box_hinside = height-2;
	char nextLine;
		
	char i;
	
	if (isTxtMode()) nextLine = 41-width;
	else nextLine = 33-width;
	
	VPOKE(vprint_addr++,24);
	DrawHorzLine(23,box_winside);
	FastVPOKE(25);
	vprint_addr+=box_winside+nextLine;
	
	for(i=1;i<box_hinside;i++)
	{		
		VPOKE(vprint_addr++,22);
		DrawHorzLine(32,box_winside);
		FastVPOKE(22);
		vprint_addr+=box_winside+nextLine;
	}		
	
	VPOKE(vprint_addr++,26);
	DrawHorzLine(23,box_winside);
	FastVPOKE(27);	
}



void DrawFillBox(char width, char height, char tile)
{
	char i;
	char nextLine;
	
	if (isTxtMode()) nextLine = 40-width;
	else nextLine = 32-width;
		
	for(i=0;i<height;i++)
	{
		SetVDPtoWRITE(vprint_addr);
		DrawHorzLine(tile,width);
		vprint_addr+=width+nextLine;
	}
}



/* -----------------------------------------------------------------------------
   GetVFrequency
  
   Get Video Frequency 
   for MSX-DOS environment
   Input: ---
   Output: 0=60Hz, 1=50Hz 
----------------------------------------------------------------------------- */  
char GetVFrequency(void) __naked
{
__asm
	push IX

; -----------------------------------
	ld   HL,#0x002D		;(MSXVER) MSX version number (0=MSX,1=MSX2,2=MSX2+,3=TurboR)
	ld   A,(#0xFCC1)	;(EXPTBL) main BIOS-ROM slot address
	call 0x000C			;(RDSLT) Reads the value of an address in another slot
	or   A
	jr   NZ,readHZfromVDP  //IF A!=0

  
;in the MSX1, the information about the video frequency is in a system variable
	ld   HL,#0x002B		;(MSXROM1)
	ld   A,(#0xFCC1)	;(EXPTBL) main BIOS-ROM slot address
	call 0x000C			;(RDSLT) Reads the value of an address in another slot
	bit  7,A			;Default interrupt frequency (0=60Hz, 1=50Hz)
	jr   Z,VFreq_isNTSC
	jr   VFreq_isPAL   

;If it is run on an MSX2 or higher, we can check the video frequency in the VDP registers.
readHZfromVDP:
;look at the system variable that contains the VDP registry value
	ld   A,(0xFFE8)    ;(RG9SAV) Mirror of VDP register 9
	bit  1,A           ;(0=60Hz, 1=50Hz)  
	jr   Z,VFreq_isNTSC
  
VFreq_isPAL:
	ld   A,#1
	pop  IX
	ret
  
VFreq_isNTSC:  
	xor  A
	pop  IX  
	ret  
__endasm;
}



boolean isTxtMode(void)
{
	char *A;
	A=(uint *) RG1SAV;
	if (*A&0b00010000) return true; //Text 40col Mode
	return false;	
}




/* =============================================================================
   Print a text in screen
============================================================================= */
void PRINT(char* text)
{ 
text;
__asm
	push IX
  
nextCHAR:  
	ld   A,(HL)
	or   A
	jr   Z,ENDnext

	ld   IX,#BIOS_CHPUT //Displays one character (BIOS)
	ld   IY,(#EXPTBL-1)
	call BIOS_CALSLT ;acces to MSX BIOS

	inc  HL
	jr   nextCHAR
ENDnext:  
	pop  IX
__endasm; 
}



void VLOCATE(char column, char line)
{
	if (isTxtMode()) vprint_addr = BASE0+(line*40)+column; //Text 40col Mode
	else vprint_addr = BASE10+(line*32)+column; //G1 or G2 modes	
}



void VPRINT(char* text)
{
	SetVDPtoWRITE(vprint_addr);
	while(*(text))
	{
		FastVPOKE(*(text++));
		vprint_addr++;
	}
}



void ClearVRAM(void)
{	
	FillVRAM(0,0x3FFF,0x00);
}



void ShowMenu(void)
{
	char i;
		
	COLOR(15,0,1);
 	SCREEN(1);
	CopyToVRAM((uint) font01Bold_sc06x8_PAT,BASE7,128*8);
	CopyToVRAM((uint) font01Bold_sc06x8_COL,BASE6,32);
	
	for(i=0;i<16;i++)
	{
		VLOCATE(i<<1,0);
		DrawFillBox(2,2,128+(8*i));
		VLOCATE(i<<1,22);
		DrawFillBox(2,2,128+(8*i));
	}
	
	VLOCATE(1,3);
	VPRINT(text01); 
	
	VLOCATE(0,4);
	DrawBox(32,14);
	
	VLOCATE(0,17);
	DrawBox(32,6);
	
	for(i=0;i<6;i++)
	{
		VLOCATE(1,6+i);
		VPRINT(textMENU[i]);
	}
		
	VLOCATE(1,18);
	VPRINT("MSX version: ");
	VPRINT(textVers[ReadBIOS(MSXVER)]); //(0=MSX1;1=MSX2;2=MSX2+;3=turboR)
	
	VLOCATE(1,19);
	VPRINT("VDP V.Freq.: ");
	VPRINT(textVFreq[GetVFrequency()]);
	
	time=30*50; //30segs in PAL
}



void Menu(void)
{
	boolean isExit=false;
	boolean Row6pressed=false;
	boolean Row7pressed=false;
	char keyPressed;
		
	ShowMenu();
	
	while(!isExit)
	{
		HALT;
		time--;
		
		if(time==0)
		{
			//testCOLOR();
			testSCREEN0();
			testSCREEN1();
			testSCREEN2();
			testSCREEN3();
			testSprites();
			ShowMenu();
		}
		
		// Keyboard row 6
		keyPressed = GetKeyMatrix(6);
		if (keyPressed!=0xFF)
		{
			if(Row6pressed==false)
			{
				//if (!(keyPressed&Bit0)) {Row6pressed=true;}; // [SHIFT]
				//if (!(keyPressed&Bit1)) {Row6pressed=true;}; // [CTRL]
				//if (!(keyPressed&Bit2)) {Row6pressed=true;}; // [GRAPH]
				//if (!(keyPressed&Bit3)) {Row6pressed=true;}; // [CAPS]
				//if (!(keyPressed&Bit4)) {Row6pressed=true;}; // [CODE]
				if (!(keyPressed&Bit5)) {Row6pressed=true;testSCREEN0();ShowMenu();}; // [F1]
				if (!(keyPressed&Bit6)) {Row6pressed=true;testSCREEN1();ShowMenu();}; // [F2]
				if (!(keyPressed&Bit7)) {Row6pressed=true;testSCREEN2();ShowMenu();}; // [F3]
			}
		}else Row6pressed=false;
		
		
		// Keyboard row 7
		keyPressed = GetKeyMatrix(7);
		if (keyPressed!=0xFF)
		{
			if(Row7pressed==false)
			{
				if (!(keyPressed&Bit0)) {Row7pressed=true;testSCREEN3();ShowMenu();}; // [F4]
				if (!(keyPressed&Bit1)) {Row7pressed=true;testSprites();ShowMenu();}; // [F5]
				if (!(keyPressed&Bit2)) {Row7pressed=true;isExit=true;}; // [ESC]
				//if (!(keyPressed&Bit3)) {Row7pressed=true;}; // [TAB]
				//if (!(keyPressed&Bit4)) {Row7pressed=true;}; // [STOP]
				//if (!(keyPressed&Bit5)) {Row7pressed=true;testCOLOR();ShowMenu();}; // [BS]
				//if (!(keyPressed&Bit6)) {Row7pressed=true;}; // [SELECT]
				//if (!(keyPressed&Bit7)) {Row7pressed=true;}; // [RETURN]
			}      
		}else Row7pressed=false;
				
	}
		
	
}




// TEST COLOR  #################################################################
/*void testCOLOR(void)
{
	char i;

	COLOR(15,4,0);
	SCREEN(0);

	CopyToVRAM((uint) font01Bold_sc06x8_PAT,BASE2,128*8);

	VLOCATE(4,2);
	DrawBox(32,20);

	VLOCATE(5,3);
	DrawFillBox(30,4,2);
	
	VLOCATE(15,11);
	VPRINT("Test COLOR");
		
	VLOCATE(5,16);
	DrawFillBox(30,4,1);
	
	WAIT(50);

	for(i=0;i<16;i++)
	{ 
		COLOR(i,15-i,0);
		WAIT(15);
	}
	WAIT(150);
}*/





// ############################################################### TEST SCREEN 0
void testSCREEN0(void)
{
	ClearVRAM();
		
	COLOR(WHITE,DARK_GREEN,0);    
	SCREEN(0);

	CopyToVRAM((uint) font01Bold_sc06x8_PAT,BASE2,128*8);

	VLOCATE(31,23);
	VPRINT(" SCREEN 0");
	WAIT(50);

	testVpeekVpoke();
	WAIT(100);

	testFill();
	WAIT(100);
	
	testCLS();
}



// ############################################################### TEST SCREEN 1
void testSCREEN1(void)
{
	char i;
	
	ClearVRAM();

	COLOR(5,4,1);   
	SCREEN(1);

	CopyToVRAM((uint) font01Bold_sc06x8_PAT,G1_PAT,128*8); 

	VLOCATE(23,23);
	VPRINT(" SCREEN 1");
	WAIT(50);

	SetVDPtoWRITE(G1_MAP);
	for(i=0;i<255;i++) FastVPOKE(i);
	WAIT(100);

	/* colors
	The BG Colors array defines 32 colors (each 4 bit background, and 4 bit 
	foreground, as in VDP register 7). The colors are assigned to the BG Tiles as
	follows: Tiles 00..07 share the first color, tiles 08..0F share the second 
	color, etc, and tiles F8..FF share the last color.*/
	CopyToVRAM((uint) tileset_06x8_COL2,G1_COL,32);
	//FillVRAM(G1_COL,32,0xF4);

	WAIT(100);

	//test fill VRAM 
	testFill();
	WAIT(100);
	
	testCLS();
}



// ############################################################### TEST SCREEN 2
void testSCREEN2(void)
{
	unsigned int i;
	char value=0;
	
	ClearVRAM();

	COLOR(0,14,1);    
	SCREEN(2);

	SetVDPtoWRITE(BASE10);
	for(i=0;i<0x300;i++) FastVPOKE(value++);	//name table in order

	VLOCATE(23,23);
	VPRINT(" SCREEN 2");

	//copy to VRAM tileset, only gfx patterns and fill colors
	//bank 0
	HALT;
	CopyToVRAM((uint) font01Bold_sc06x8_PAT,BASE12,128*8);
	FillVRAM(BASE11,128*8,0x96);		//colors (Red)
	
	WAIT(50);
	
	//test CopyFromVRAM
	VLOCATE(0,5);
	VPRINT("Test CopyFromVRAM()");
	//copy VRAM to RAM
	CopyFromVRAM(BASE12,(uint) tilesetBakup,128*8);
	WAIT(50);
	
	
	//test CopyToVRAM 
	VLOCATE(0,6);
	VPRINT("Test CopyToVRAM BANK1");
	//copy VRAM to RAM
	CopyToVRAM((uint) tilesetBakup,BASE12+BANK1,128*8);
	FillVRAM(BASE11+BANK1,128*8,0x3C);	//colors (green)
	WAIT(50);
	
	//test CopyToVRAM 
	VLOCATE(0,7);
	VPRINT("Test CopyToVRAM BANK2");
	//copy VRAM to RAM
	CopyToVRAM((uint) tilesetBakup,BASE12+BANK2,128*8);
	FillVRAM(BASE11+BANK2,128*8,0x54);	//colors (blue)
	
	WAIT(120);	
	
	//test fill VRAM  
	testFill();
	WAIT(100);
	
	testCLS();
}



// ############################################################### TEST SCREEN 3
void testSCREEN3(void)
{
	char value=0;
	char loop;
	char loopLine;
	
	ClearVRAM();

	COLOR(0,4,CYAN);
	SCREEN(1);

	FillVRAM(BASE6, 32, 0xE4);
	CopyToVRAM((uint) font01Bold_sc06x8_PAT,BASE7,128*8);

	VLOCATE(10,11);
	VPRINT("Test SCREEN 3");

	WAIT(200);
	
	FillVRAM(BASE17, 0x600, 0); //clear screen 3 pattern table
	
	COLOR(0,0,BLACK);
	SCREEN(3);	
	SortMCmap();

	value=0;
	SetVDPtoWRITE(BASE17);
	//for(loop=0;loop<0x600;loop++)
	for(loop=0;loop<192;loop++)
	{
		HALT;
		for(loopLine=0;loopLine<8;loopLine++) FastVPOKE(value++);
	}
	//for(i=0;i<0x300;i++) VPOKE(BASE15+i,value++);  //name table in order

	WAIT(100);
	CLS();
	WAIT(150);
}



void testCLS(void)
{
	unsigned int BC;
	unsigned int vaddr;	
	unsigned int vsize;
	boolean testResult=true;
	
	if (isTxtMode()){
		vaddr=T1_MAP;
		vsize=0x3C0;
	}else{
		vaddr=G1_MAP;
		vsize=0x300;
	}
	
	FillVRAM(vaddr, vsize, 2);
	VLOCATE(0,0);
	VPRINT(text10);
 
	WAIT(150);
	
	CLS();
	WAIT(25);
	
	for(BC=0;BC<vsize;BC++) if(VPEEK(vaddr++)!=0) testResult=false;
		
	WAIT(25);
	VLOCATE(0,0);
	VPRINT(text10);
	if(testResult==true) VPRINT("=Ok");
	else VPRINT("=ERROR!");
	
	WAIT(150);
}



// TEST VPEEK & VPOKE  #########################################################
// copy a bloq using vpeek and vpoke
void testVpeekVpoke(void)
{
	uint vaddr;
	char i;
	char value;

	//test FastVPOKE
	VLOCATE(0,0);
	VPRINT("Test FastVPOKE:");
	SetVDPtoWRITE(BASE0+40);
	for(i=0;i<255;i++) FastVPOKE(i);

	WAIT(100);

	//test VPOKE & VPEEK
	VLOCATE(0,9);
	VPRINT("Test VPEEK and VPOKE:");
	vaddr=BASE0+40;
	for(i=0;i<255;i++)
	{
		HALT;
		value = VPEEK(vaddr);
		VPOKE(vaddr+(10*40),value);
		vaddr++;  
	}

}



// TEST FILL  ##################################################################
//fill screen map with a characters range 
void testFill(void)
{
	char i;
	uint vaddr;
	uint size;
	
	if (isTxtMode()){
		vaddr=T1_MAP+10;
		size=942; //Text 40col Mode		
	}else{
		vaddr=G1_MAP+10;
		size=750; //G1 or G2 modes
	}
	
	VLOCATE(0,0);
	VPRINT("FillVRAM()");
	for(i=32;i<95;i++)
	{
		HALT;
		HALT;
		HALT;
		HALT;

		FillVRAM (vaddr, size, i);    
	}  
  
}



// ################################################################ TEST Sprites
void testSprites(void)
{
	COLOR(0,0,1);
	SCREEN(1);

	CopyToVRAM((uint) font01Bold_sc06x8_PAT,BASE7,128*8);
	CopyToVRAM((uint) font01Bold_sc06x8_COL,BASE6,32);
	CopyToVRAM((uint) SPRITE_DATA,BASE14,32*10);

	VLOCATE(0,0);
	VPRINT("Test Sprites");  
	WAIT(50);

	// sprites 8x8
	//setupSprites(0,false); //16x16 no zoom
	VLOCATE(0,2);
	VPRINT("SetSpritesSize(0) SPRITES 8x8");
	SetSpritesSize(0);
	SetSpritesZoom(false);  
	showSprites(0);
	WAIT(100);

	// test sprites 16x16
	//setupSprites(1,false);
	VLOCATE(0,3);
	VPRINT("SetSpritesSize(1) SPRITES 16x16");
	SetSpritesSize(1);
	showSprites(2);
	WAIT(100);

	// test sprites 16x16 + zoom  
	//setupSprites(1,true);
	VLOCATE(0,4);
	VPRINT("SetSpritesZoom(true) SPRITES x2");
	SetSpritesZoom(true);
	WAIT(100);


	VLOCATE(0,5);
	VPRINT("ClearSprites()");
	ClearSprites();
	WAIT(150);
}



// ############################################################# TEST PUTSPRITE
void showSprites(char offset)
{
	char X=2,Y=2;
	char i=0;
	char sprpat=0;
	
	/*VLOCATE(7,11);
	DrawBox(18,11);*/

	for(i=0;i<16;i++)
	{
		PUTSPRITE(i, X*32, Y*32, sprcol[sprpat], sprpat+offset);
		sprpat++;
		X++;
		if(X==6)
		{
			X=2;
			Y++;
		}
		if (sprpat>7) sprpat=0;
	}
}

